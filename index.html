<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ü§ñ Robot Asistente TEC - Control Web</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      text-align: center;
    }

    .header h1 {
      color: #0038a8;
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header .subtitle {
      color: #666;
      font-size: 1.1em;
    }

    .status-card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .status-card h2 {
      color: #0038a8;
      margin-bottom: 20px;
      font-size: 1.8em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .status-item {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 15px;
      border-left: 5px solid #667eea;
    }

    .status-item .label {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .status-item .value {
      color: #333;
      font-size: 1.3em;
      font-weight: bold;
    }

    .status-badge {
      display: inline-block;
      padding: 8px 20px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 1.1em;
    }

    .status-badge.disponible {
      background: #4CAF50;
      color: white;
    }

    .status-badge.ocupado {
      background: #FF9800;
      color: white;
    }

    .status-badge.navegando {
      background: #2196F3;
      color: white;
    }

    .status-badge.desconectado {
      background: #f44336;
      color: white;
    }

    .map-container {
      background: #e8eaf6;
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
      min-height: 200px;
      position: relative;
    }

    .map-container h3 {
      color: #0038a8;
      margin-bottom: 15px;
    }

    .location-info {
      display: flex;
      align-items: center;
      gap: 15px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .location-icon {
      font-size: 2em;
    }

    .control-section {
      background: white;
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .control-section h2 {
      color: #0038a8;
      margin-bottom: 20px;
      font-size: 1.8em;
    }

    .destination-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .destination-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 20px;
      border-radius: 15px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .destination-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }

    .destination-btn:active {
      transform: translateY(0);
    }

    .destination-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .call-robot-section {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      text-align: center;
    }

    .call-robot-section h2 {
      color: white;
      margin-bottom: 15px;
      font-size: 2em;
    }

    .call-robot-section p {
      color: white;
      margin-bottom: 20px;
      font-size: 1.1em;
    }

    .call-robot-btn {
      background: white;
      color: #f5576c;
      border: none;
      padding: 20px 40px;
      border-radius: 50px;
      font-size: 1.3em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .call-robot-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    }

    .call-robot-btn:disabled {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
      transform: none;
    }

    .motor-control {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    .motor-btn {
      background: #1976D2;
      color: white;
      border: none;
      padding: 15px;
      border-radius: 10px;
      font-size: 1.2em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .motor-btn:hover {
      background: #0D47A1;
      transform: scale(1.05);
    }

    .motor-btn:active {
      transform: scale(0.95);
    }

    .motor-btn.stop {
      background: #FF9800;
    }

    .motor-btn.stop:hover {
      background: #F57C00;
    }

    .connection-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 15px 25px;
      border-radius: 50px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
    }

    .connection-dot {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: gray;
      animation: pulse 2s infinite;
    }

    .connection-dot.connected {
      background: #4CAF50;
    }

    .connection-dot.disconnected {
      background: #f44336;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .log-section {
      background: white;
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .log-section h2 {
      color: #0038a8;
      margin-bottom: 15px;
    }

    .log-container {
      background: #1e1e1e;
      color: #00ff00;
      padding: 20px;
      border-radius: 10px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    .log-entry {
      margin-bottom: 5px;
      padding: 5px;
      border-left: 3px solid #00ff00;
      padding-left: 10px;
    }

    .log-entry.error {
      border-left-color: #ff0000;
      color: #ff6b6b;
    }

    .log-entry.warning {
      border-left-color: #ffaa00;
      color: #ffd93d;
    }

    .emergency-stop {
      background: #f44336;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 1.2em;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
      width: 100%;
      transition: all 0.3s ease;
    }

    .emergency-stop:hover {
      background: #d32f2f;
      transform: scale(1.02);
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.8em;
      }
      
      .status-grid {
        grid-template-columns: 1fr;
      }
      
      .destination-buttons {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="connection-indicator">
    <div class="connection-dot" id="connectionDot"></div>
    <span id="connectionText">Conectando...</span>
  </div>

  <div class="container">
    <!-- HEADER -->
    <div class="header">
      <h1>ü§ñ Robot Asistente TEC</h1>
      <p class="subtitle">Sistema de Navegaci√≥n y Control Inteligente</p>
    </div>

    <!-- ESTADO DEL ROBOT -->
    <div class="status-card">
      <h2>üìä Estado del Robot</h2>
      
      <div style="text-align: center; margin-bottom: 20px;">
        <span class="status-badge" id="robotStatus">Desconectado</span>
      </div>

      <div class="status-grid">
        <div class="status-item">
          <div class="label">üìç Ubicaci√≥n Actual</div>
          <div class="value" id="currentLocation">Desconocida</div>
        </div>
        
        <div class="status-item">
          <div class="label">üéØ Destino</div>
          <div class="value" id="destination">Ninguno</div>
        </div>
        
        <div class="status-item">
          <div class="label">üìè Distancia</div>
          <div class="value" id="distance">-- m</div>
        </div>
        
        <div class="status-item">
          <div class="label">üîã Bater√≠a</div>
          <div class="value" id="battery">---%</div>
        </div>
      </div>

      <div class="map-container">
        <h3>üó∫Ô∏è Mapa del Campus</h3>
        <div class="location-info">
          <span class="location-icon">üìç</span>
          <div>
            <strong>Coordenadas GPS:</strong><br>
            <span id="gpsCoords">Esperando GPS...</span>
          </div>
        </div>
        <div class="location-info">
          <span class="location-icon">üß≠</span>
          <div>
            <strong>Direcci√≥n:</strong><br>
            <span id="direction">--</span>
          </div>
        </div>
      </div>
    </div>

    <!-- LLAMAR AL ROBOT -->
    <div class="call-robot-section">
      <h2>üìû Llamar al Robot</h2>
      <p>El robot vendr√° a tu ubicaci√≥n si est√° disponible y dentro de la zona segura</p>
      <button class="call-robot-btn" id="callRobotBtn" onclick="callRobot()">
        üöÄ Llamar Robot a Mi Ubicaci√≥n
      </button>
      <p style="margin-top: 15px; font-size: 0.9em;" id="callStatus"></p>
    </div>

    <!-- DESTINOS -->
    <div class="control-section">
      <h2>üéØ Enviar Robot a Destino</h2>
      <p style="color: #666; margin-bottom: 20px;">Selecciona un destino para que el robot te gu√≠e</p>
      
      <div class="destination-buttons">
        <button class="destination-btn" onclick="sendToDestination('timhortons')">
          ‚òï Tim Hortons
        </button>
        <button class="destination-btn" onclick="sendToDestination('biblioteca')">
          üìö Biblioteca
        </button>
        <button class="destination-btn" onclick="sendToDestination('cafeteria')" disabled>
          üçΩÔ∏è Cafeter√≠a<br><small>(Pr√≥ximamente)</small>
        </button>
        <button class="destination-btn" onclick="sendToDestination('aulas')" disabled>
          üè´ Aulas<br><small>(Pr√≥ximamente)</small>
        </button>
      </div>

      <button class="emergency-stop" onclick="emergencyStop()">
        üõë DETENER ROBOT (EMERGENCIA)
      </button>
    </div>

    <!-- CONTROL MANUAL -->
    <div class="control-section">
      <h2>üéÆ Control Manual</h2>
      <p style="color: #666; margin-bottom: 20px;">Solo usar si el robot est√° disponible</p>
      
      <div class="motor-control">
        <div></div>
        <button class="motor-btn" onclick="sendCommand('AVANZAR')">‚¨ÜÔ∏è</button>
        <div></div>
        
        <button class="motor-btn" onclick="sendCommand('IZQUIERDA')">‚¨ÖÔ∏è</button>
        <button class="motor-btn stop" onclick="sendCommand('QUIETO')">‚èπÔ∏è</button>
        <button class="motor-btn" onclick="sendCommand('DERECHA')">‚û°Ô∏è</button>
        
        <div></div>
        <button class="motor-btn" onclick="sendCommand('ATRAS')">‚¨áÔ∏è</button>
        <div></div>
      </div>
    </div>

    <!-- LOG DE EVENTOS -->
    <div class="log-section">
      <h2>üìã Registro de Eventos</h2>
      <div class="log-container" id="logContainer">
        <div class="log-entry">Sistema iniciando...</div>
      </div>
    </div>
  </div>

  <!-- SCRIPT MQTT Y L√ìGICA -->
  <script>
    // ====
    // CONFIGURACI√ìN MQTT
    // ====
    const broker = 'wss://958d6cbfe5ce4f0581776ff12f2049b4.s1.eu.hivemq.cloud:8884/mqtt';
    const options = {
      username: "Omarkings",
      password: "567129Aa",
      connectTimeout: 4000,
      reconnectPeriod: 3000
    };

    const client = mqtt.connect(broker, options);

    // Topics
    const TOPICS = {
      gps: "omar/robot/gps",
      gps_status: "omar/robot/gps_status",
      estado: "omar/robot/estado",
      geocerca: "omar/robot/geocerca",
      navigation: "omar/robot/navigation",
      manual: "omar/manual/accion",
      alerta: "kinect/alerta_led"
    };

    // Estado global
    let robotState = {
      status: 'desconectado',
      lat: null,
      lon: null,
      destination: null,
      distance: null,
      gpsAvailable: false,
      busy: false
    };

    let userLocation = null;

    // ====
    // FUNCIONES DE LOG
    // ====
    function addLog(message, type = 'info') {
      const logContainer = document.getElementById('logContainer');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
      
      // Limitar a 100 entradas
      while (logContainer.children.length > 100) {
        logContainer.removeChild(logContainer.firstChild);
      }
    }

    // ====
    // EVENTOS MQTT
    // ====
    client.on('connect', () => {
      console.log("‚úÖ Conectado a HiveMQ Cloud");
      document.getElementById('connectionDot').className = 'connection-dot connected';
      document.getElementById('connectionText').textContent = 'Conectado';
      
      // Suscribirse a todos los topics
      Object.values(TOPICS).forEach(topic => {
        client.subscribe(topic);
      });
      
      addLog('Conectado al broker MQTT', 'info');
      updateRobotStatus('disponible');
    });

    client.on('error', (error) => {
      console.error("‚ùå Error de conexi√≥n:", error);
      document.getElementById('connectionDot').className = 'connection-dot disconnected';
      document.getElementById('connectionText').textContent = 'Desconectado';
      addLog('Error de conexi√≥n: ' + error.message, 'error');
    });

    client.on('message', (topic, message) => {
      const msg = message.toString();
      
      switch(topic) {
        case TOPICS.gps:
          handleGPSUpdate(msg);
          break;
        case TOPICS.gps_status:
          handleGPSStatus(msg);
          break;
        case TOPICS.estado:
          handleEstadoUpdate(msg);
          break;
        case TOPICS.geocerca:
          handleGeocercaUpdate(msg);
          break;
      }
    });

    // ====
    // HANDLERS DE MENSAJES
    // ====
    function handleGPSUpdate(msg) {
      try {
        const parts = msg.split('|');
        const coords = parts[0].split(',');
        robotState.lat = parseFloat(coords[0]);
        robotState.lon = parseFloat(coords[1]);
        
        document.getElementById('gpsCoords').textContent = 
          `${robotState.lat.toFixed(6)}, ${robotState.lon.toFixed(6)}`;
        
        addLog(`GPS actualizado: ${robotState.lat.toFixed(6)}, ${robotState.lon.toFixed(6)}`);
        
        // Actualizar ubicaci√≥n actual
        updateCurrentLocation();
      } catch (e) {
        addLog('Error parseando GPS: ' + e.message, 'error');
      }
    }

    function handleGPSStatus(msg) {
      robotState.gpsAvailable = (msg === 'DISPONIBLE');
      addLog(`GPS del robot: ${msg}`);
    }

    function handleEstadoUpdate(msg) {
      addLog(`Estado: ${msg}`);
      
      if (msg.includes('navegando') || msg.includes('avanzando')) {
        updateRobotStatus('navegando');
      } else if (msg.includes('ocupado') || msg.includes('llevando')) {
        updateRobotStatus('ocupado');
      } else if (msg.includes('quieto') || msg.includes('detenido')) {
        updateRobotStatus('disponible');
      }
    }

    function handleGeocercaUpdate(msg) {
      if (msg === 'FUERA') {
        addLog('‚ö†Ô∏è Robot fuera de geocerca!', 'warning');
      }
    }

    // ====
    // ACTUALIZAR UI
    // ====
    function updateRobotStatus(status) {
      robotState.status = status;
      const badge = document.getElementById('robotStatus');
      
      badge.className = 'status-badge';
      
      switch(status) {
        case 'disponible':
          badge.classList.add('disponible');
          badge.textContent = '‚úÖ Disponible';
          robotState.busy = false;
          break;
        case 'ocupado':
          badge.classList.add('ocupado');
          badge.textContent = '‚è≥ Ocupado';
          robotState.busy = true;
          break;
        case 'navegando':
          badge.classList.add('navegando');
          badge.textContent = 'üöÄ Navegando';
          robotState.busy = true;
          break;
        default:
          badge.classList.add('desconectado');
          badge.textContent = '‚ùå Desconectado';
          robotState.busy = false;
      }
      
      updateCallButton();
    }

    function updateCurrentLocation() {
      // Determinar ubicaci√≥n aproximada basada en coordenadas
      if (!robotState.lat || !robotState.lon) return;
      
      const locations = {
        timhortons: { lat: 20.613984, lon: -100.403511, name: 'Tim Hortons' },
        biblioteca: { lat: 20.613246, lon: -100.403285, name: 'Biblioteca' }
      };
      
      let nearest = null;
      let minDist = Infinity;
      
      for (let [key, loc] of Object.entries(locations)) {
        const dist = calculateDistance(robotState.lat, robotState.lon, loc.lat, loc.lon);
        if (dist < minDist && dist < 50) { // Dentro de 50 metros
          minDist = dist;
          nearest = loc.name;
        }
      }
      
      document.getElementById('currentLocation').textContent = 
        nearest || 'En tr√°nsito';
    }

    function updateCallButton() {
      const btn = document.getElementById('callRobotBtn');
      btn.disabled = robotState.busy;
      
      if (robotState.busy) {
        btn.textContent = '‚è≥ Robot Ocupado';
      } else {
        btn.textContent = 'üöÄ Llamar Robot a Mi Ubicaci√≥n';
      }
    }

    // ====
    // FUNCIONES DE CONTROL
    // ====
    function sendCommand(cmd) {
      if (robotState.busy && cmd !== 'QUIETO') {
        addLog('Robot ocupado, comando ignorado', 'warning');
        return;
      }
      
      client.publish(TOPICS.manual, cmd);
      addLog(`Comando manual enviado: ${cmd}`);
    }

    function sendToDestination(dest) {
      if (robotState.busy) {
        addLog('Robot ocupado, no se puede enviar a destino', 'warning');
        alert('El robot est√° ocupado actualmente');
        return;
      }
      
      const destinations = {
        timhortons: 'Tim Hortons',
        biblioteca: 'Biblioteca'
      };
      
      const destName = destinations[dest];
      
      if (!destName) {
        addLog('Destino no disponible', 'error');
        return;
      }
      
      // Enviar comando de navegaci√≥n
      client.publish(TOPICS.navigation, `NAVEGAR_${dest.toUpperCase()}`);
      
      document.getElementById('destination').textContent = destName;
      updateRobotStatus('navegando');
      
      addLog(`üéØ Robot enviado a: ${destName}`);
      alert(`Robot en camino a ${destName}`);
    }

    function callRobot() {
      if (robotState.busy) {
        alert('El robot est√° ocupado actualmente');
        return;
      }
      
      // Obtener ubicaci√≥n del usuario
      if (!navigator.geolocation) {
        alert('Tu navegador no soporta geolocalizaci√≥n');
        return;
      }
      
      document.getElementById('callStatus').textContent = 'üìç Obteniendo tu ubicaci√≥n...';
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          userLocation = {
            lat: position.coords.latitude,
            lon: position.coords.longitude
          };
          
          // Verificar si est√° en zona segura (campus)
          if (!isInSafeZone(userLocation.lat, userLocation.lon)) {
            alert('‚ö†Ô∏è Est√°s fuera de la zona segura del campus. El robot no puede ir a tu ubicaci√≥n.');
            document.getElementById('callStatus').textContent = '‚ùå Fuera de zona segura';
            addLog('Llamada rechazada: fuera de zona segura', 'warning');
            return;
          }
          
          // Enviar ubicaci√≥n al robot
          const locationMsg = `${userLocation.lat},${userLocation.lon}`;
          client.publish(TOPICS.navigation, `VENIR_A:${locationMsg}`);
          
          document.getElementById('callStatus').textContent = '‚úÖ Robot en camino a tu ubicaci√≥n';
          updateRobotStatus('navegando');
          
          addLog(`üìû Robot llamado a: ${userLocation.lat.toFixed(6)}, ${userLocation.lon.toFixed(6)}`);
          alert('¬°Robot en camino a tu ubicaci√≥n!');
        },
        (error) => {
          alert('No se pudo obtener tu ubicaci√≥n: ' + error.message);
          document.getElementById('callStatus').textContent = '‚ùå Error obteniendo ubicaci√≥n';
          addLog('Error de geolocalizaci√≥n: ' + error.message, 'error');
        }
      );
    }

    function emergencyStop() {
      if (confirm('¬øEst√°s seguro de detener el robot en emergencia?')) {
        client.publish(TOPICS.manual, 'QUIETO');
        client.publish(TOPICS.alerta, 'ON');
        
        updateRobotStatus('disponible');
        document.getElementById('destination').textContent = 'Ninguno';
        
        addLog('üõë PARADA DE EMERGENCIA ACTIVADA', 'error');
        alert('Robot detenido');
      }
    }

    // ====
    // FUNCIONES AUXILIARES
    // ====
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000; // Radio de la Tierra en metros
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

      const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c;
    }

    function isInSafeZone(lat, lon) {
      // Geocerca del ITESM Quer√©taro (pol√≠gono simplificado)
      const bounds = {
        minLat: 20.612,
        maxLat: 20.615,
        minLon: -100.404,
        maxLon: -100.402
      };
      
      return lat >= bounds.minLat && lat <= bounds.maxLat &&
             lon >= bounds.minLon && lon <= bounds.maxLon;
    }

    // ====
    // INICIALIZACI√ìN
    // ====
    window.onload = () => {
      addLog('Sistema web iniciado');
      addLog('Esperando conexi√≥n con el robot...');
    };
  </script>
</body>
</html>
